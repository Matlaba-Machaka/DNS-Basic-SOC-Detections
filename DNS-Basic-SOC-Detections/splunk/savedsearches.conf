# savedsearches.conf
search = index=linux sourcetype=linux_secure (("Failed password" OR "invalid user") AND src!="") 
         | eval src=coalesce(src, client_ip, src_ip)
         | bin _time span=5m
         | stats count AS fails by src,_time
         | where fails>=10
         | fields src, fails, _time
cron_schedule = */5 * * * *
dispatch.earliest_time = -15m
dispatch.latest_time = now
actions = addtoincident
alert.severity = 3
description = Simple 5-minute aggregation of SSH auth failures per source.

[Windows Brute Force Burst - 4625 (Beginner)]
search = index=wineventlog EventCode=4625
         | eval src_ip=coalesce(Source_Network_Address, IpAddress, src_ip)
         | stats count AS fails values(TargetUserName) AS users by src_ip
         | where fails>=20
         | fields src_ip, fails, users
cron_schedule = */5 * * * *
dispatch.earliest_time = -30m
dispatch.latest_time = now
actions = addtoincident
alert.severity = 3
description = Count of failed Windows logon events (4625) per source IP.

[Phishing - HTML Attachment Lure (Beginner)]
search = index=o365 sourcetype=o365:messageTrace (fileExtension="html" OR fileExtension="htm") action!="Blocked"
         | dedup messageId
         | stats count AS html_count latest(subject) AS subject values(recipientAddress) AS recipients by senderAddress
         | where html_count>=1
         | fields senderAddress, html_count, subject, recipients
cron_schedule = */10 * * * *
dispatch.earliest_time = -60m
dispatch.latest_time = now
actions = addtoincident
alert.severity = 4
description = Detects emails with HTML/HTM attachments that were not blocked.

[DNS Tunneling - Long Labels / TXT (Beginner)]
search = index=dns (query_type=TXT OR query_length>100 OR label_length>50)
         | eval query=coalesce(query, dns_qry_name)
         | eval parent_domain=if(match(query,"\\."), replace(query,"^[^.]+\\.",""), query)
         | stats count avg(query_length) AS avg_len sum(eval(rcode=="NXDOMAIN")) AS nxd values(src_ip) AS hosts by parent_domain
         | where count>=50 OR avg_len>80 OR nxd>25
         | fields parent_domain, count, avg_len, nxd, hosts
cron_schedule = */10 * * * *
dispatch.earliest_time = -60m
dispatch.latest_time = now
actions = addtoincident
alert.severity = 4
description = Flags domains with many long/TXT or NXDOMAIN queries (possible DNS tunneling).
